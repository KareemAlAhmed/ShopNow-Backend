<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update User - ShopNow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/updateUser.css}">

</head>
<body>
<script th:src="@{/js/updateUser.js}"></script>
<!-- Navigation Header -->
<header style="background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px 0;">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="logo" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                Shop<span style="color: var(--secondary);">Now</span>
            </div>
            <nav>
                <a th:href="@{/}" class="btn btn-secondary" style="margin-right: 10px;">
                    <i class="fas fa-arrow-left"></i> Back to Users
                </a>

            </nav>
        </div>
    </div>
</header>

<div class="container">
    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div class="card">
        <div class="header">
            <div class="user-avatar">
                <div class="avatar">
                    <i class="fas fa-user-edit"></i>
                </div>
            </div>
            <h1>Update User Information</h1>
            <p>Edit the user details below</p>
        </div>

        <!-- Update Form -->
        <form th:action="@{/user/update/{id}(id=${user.id})}" method="post" th:object="${user}" id="updateForm">


            <div class="form-row">
                <div class="form-group">
                    <label for="id">User ID</label>
                    <input type="text" id="id" th:value="${user.id}" class="form-control readonly-field" readonly>
                </div>

                <div class="form-group">
                    <label >Status</label>
                    <div>
                            <span th:if="${user.enabled}" class="status-badge status-active">
                                <i class="fas fa-check-circle"></i> Active
                            </span>
                        <span th:unless="${user.enabled}" class="status-badge status-inactive">
                                <i class="fas fa-times-circle"></i> Inactive
                            </span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="username">Username *</label>
                <input type="text" id="username" th:field="*{username}" class="form-control readonly-field" required readonly>
                <small style="color: var(--gray); font-size: 0.9rem;">Username cannot be changed</small>
            </div>

            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" th:field="*{email}" class="form-control" required >
            </div>

            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" th:field="*{phone}" class="form-control" placeholder="+1234567890">
            </div>

            <!-- Role Information (Display only) -->
            <div class="form-group">
                <label>Current Role</label>
                <div>

                    <span th:if="${userRoles.contains('ROLE_USER')}" class="userRole givenRole" onclick="selectRole(event,'ROLE_USER')">User</span>
                    <span th:unless="${userRoles.contains('ROLE_USER')}" class="userRole notGivenRole" onclick="selectRole(event,'ROLE_USER')">User</span>

                    <span th:if="${userRoles.contains('ROLE_ADMIN')}" class="userRole givenRole" onclick="selectRole(event,'ROLE_ADMIN')">Admin</span>
                    <span th:unless="${userRoles.contains('ROLE_ADMIN')}" class="userRole notGivenRole" onclick="selectRole(event,'ROLE_ADMIN')">Admin</span>

                </div>
<!--                <small style="color: var(&#45;&#45;gray); font-size: 0.9rem;">Role changes require administrator privileges</small>-->
            </div>

            <!-- Password Section -->
            <div class="form-group">
                <label>Password</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="password" value="********" class="form-control readonly-field" readonly style="flex: 1;">
                    <button type="button" class="btn btn-secondary" onclick="showResetPassword()">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                </div>
            </div>
            <input type="hidden" id="selectedRoles" name="selectedRoles" value="">
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" onclick="updateUser(event)">
                    <i class="fas fa-save"></i> Update User
                </button>
                <a th:href="@{/}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()"

                >
                    <i class="fas fa-trash"></i> Delete User
                </button>
            </div>
        </form>
    </div>

    <!-- Additional Actions Card -->
    <div class="card" style="margin-top: 20px;">
        <h3 style="margin-bottom: 20px; color: var(--dark);">Quick Actions</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">

            <a th:href="@{/users/view/{id}(id=${user.id})}" class="btn btn-secondary" style="text-align: center;">
                <i class="fas fa-eye"></i> View Profile
            </a>

        </div>
    </div>
    <form th:action="@{/user/delete/{id}(id=${user.id})}" class="deleteForm" method="post">

    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
        let userRoleSelections = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Thymeleaf will process this correctly
            const userRoles = [[${userRoles}]];

            if (userRoles) {
                userRoles.forEach(roles => {
                    userRoleSelections.push(roles);
                });
            }

            console.log('User roles loaded:', userRoleSelections);
        });
        function updateUser(e){
            e.preventDefault();
            document.getElementById('selectedRoles').value = userRoleSelections.join(',');
            document.getElementById("updateForm").submit();
        }


        function selectRole(e,role){

             if (userRoleSelections.includes(role)) {
                // Remove role
                const index = userRoleSelections.indexOf(role);
                userRoleSelections.splice(index, 1);
                e.target.classList.remove('givenRole');
                e.target.classList.add('notGivenRole');
            } else {
                // Add role
                userRoleSelections.push(role);
                e.target.classList.remove('notGivenRole');
                e.target.classList.add('givenRole');
            }

            console.log(userRoleSelections.join(','));

        }




    /*]]>*/
</script>


<!--<script>-->
<!--    function confirmDelete() {-->
<!--        if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {-->
<!--            window.location.href = '/users/delete/' + [[${user.id}]];-->
<!--        }-->
<!--    }-->

<!--    function showResetPassword() {-->
<!--        alert('Password reset functionality would be implemented here.');-->
<!--        // You can implement a modal or redirect to password reset page-->
<!--    }-->

<!--    function showActivityLog() {-->
<!--        alert('User activity log would be displayed here.');-->
<!--        // Implement activity log display-->
<!--    }-->

<!--    // Form validation-->
<!--    document.querySelector('form').addEventListener('submit', function(e) {-->
<!--        const email = document.getElementById('email').value;-->
<!--        const username = document.getElementById('username').value;-->

<!--        if (!username.trim()) {-->
<!--            alert('Username is required');-->
<!--            e.preventDefault();-->
<!--            return;-->
<!--        }-->

<!--        if (!email.trim() || !isValidEmail(email)) {-->
<!--            alert('Please enter a valid email address');-->
<!--            e.preventDefault();-->
<!--            return;-->
<!--        }-->
<!--    });-->

<!--    function isValidEmail(email) {-->
<!--        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;-->
<!--        return emailRegex.test(email);-->
<!--    }-->
<!--</script>-->
</body>
</html>